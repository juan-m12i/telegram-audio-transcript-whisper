- Resolved merge conflict in PR #27: Merged origin/main into dev branch. Conflict was in agent.log - resolved by combining all log entries from both branches.
- Added .mypy_cache/ and .pytest_cache/ to rsync exclusions in deploy-vps.sh (dev-only caches not needed on server).
- Analyzed CloudWatch ERROR traces from Telegram bots on AWS Lightsail. Identified root cause as unhandled exceptions with no error handlers registered. All 5 bots failed simultaneously, suggesting external API/network issue. Recommended adding error handlers and checking full tracebacks.
- Root cause confirmed: telegram.error.NetworkError (httpx.ReadError) - transient network interruption during get_updates() polling. Bots auto-recovered via built-in retry logic. No code bug, just network hiccup.
- Added NetworkErrorTracker and error handler to bot_common.py. Transient network errors (1-4 in 5 min) log at INFO. Persistent errors (5+ in 5 min) escalate to ERROR. Non-network errors always ERROR.
Added AGENTS.md instructions and updated .gitignore
Added acknowledgment message before transcription
Fixed malformed summary prompt in gpt_whisper_bot
Added architecture review
Implemented timestamp storage in Notion logs for notes, transcripts, and summaries
Pinned dependency versions (including pytz) to stabilize docker bots
Fixed PR review issues: removed double timestamps, fixed zero value handling, added chunking for long transcripts/summaries
Created deploy-vps.sh script following three-folder pattern for VPS deployment
Fixed PR review bugs: corrected sentence rejoining to use spaces instead of newlines, added validation to prevent chunks exceeding max_chunk_size limit
2025-11-14 10:28:07 - Updated timestamp handling to use Argentina timezone (America/Argentina/Buenos_Aires) instead of UTC. Added timezone conversion functions with zoneinfo/pytz fallback support.
2025-11-14 10:30:43 - Refactored timezone handling to use configurable timezone with sensible default (Argentina/GMT-3). Moved common timezone functions to bot/bot_common.py. Timezone can be overridden via TIMEZONE environment variable.
2025-11-14 10:33:47 - Resolved merge conflicts by merging dev into main. Conflicts were in agent.log and gpt_whisper_bot.py - resolved cleanly with all changes from both branches preserved.
2025-01-XX XX:XX:XX - Fixed timezone handling: Added fallback to pytz when ZoneInfo fails due to missing tzdata database (e.g., on Alpine Linux). Catches ZoneInfoNotFoundError and KeyError to ensure bots work on minimal Python environments.
2025-11-14 13:54:06 - Fixed FileNotFoundError when downloading audio files: Added os.makedirs('audio_files', exist_ok=True) to ensure directory exists before writing files in Docker container.
2025-11-14 13:54:06 - Renamed deploy-vps-deploy.sh to deploy-vps.sh for better naming consistency.
2025-01-15 XX:XX:XX - Implemented storage adapter pattern for abstracting note storage backends. Created StorageAdapter abstract base class, refactored NotionAdapter to implement it (backward compatible), added ApiAdapter for HTTP API storage with idempotent POST endpoint. Created workout_bot.py with support for both new messages and message edits. API handles create/update logic based on message_id, uses Bearer token auth and composite chat_id+message_id identifiers.
2025-11-16 XX:XX:XX - Updated workout_bot to use message reactions instead of reply messages. Upgraded python-telegram-bot from 20.2 to 22.5 for reaction support. Bot now reacts with ðŸ‘ for new notes and â¤ï¸ for updated notes. Fixed env file loading order to ensure workout_bot.env is loaded before bot_common imports. Added logic to clear previous reactions before setting new ones on message edits.
2025-01-XX XX:XX:XX - Fixed httpx dependency conflict: Updated httpx from 0.25.2 to >=0.27,<0.29 to satisfy python-telegram-bot 22.x requirements while maintaining compatibility with notion-client 2.0.0.
2025-11-17 XX:XX:XX - Fixed workout bot network connectivity: Added workout_bot to docker-services-network in docker_compose.yml and updated NOTES_API_URL from localhost to data-manager container name for proper Docker service discovery. Deployed to VPS - workout_bot container now on docker-services-network and can connect to data-manager API.
2025-11-17 13:21:06 - Audited repo for exposed secrets and deployment risks; no secrets found, noted third-party data handling and infra disclosures.
2025-11-17 XX:XX:XX - Fixed workout bot network connectivity: Added workout_bot to docker-services-network in docker_compose.yml and updated NOTES_API_URL from localhost to data-manager container name for proper Docker service discovery. Deployed to VPS - workout_bot container now on docker-services-network and can connect to data-manager API. Removed conflicting whisper bot container and recreated all containers successfully. Updated deploy-vps.sh to include workout_bot.env in environment file checks and cont-telegram-workout-bot in container verification. Updated docker_compose_recreate.sh to handle network cleanup gracefully without suppressing errors.
2025-11-17 XX:XX:XX - Implemented log sanitization for Telegram bot API tokens: Created TokenSanitizingFilter class in bot_common.py that obfuscates bot tokens in httpx/httpcore logs using fingerprint format (first 4 + last 4 chars) matching bot_lookup.py pattern. Filter applied to httpx and httpcore loggers globally. Tokens in URLs like "bot5863831530:AAGwypCaB7Zux6S7LeepCTWjYqWJOG1vl6Y" are now sanitized to "bot5863831530:5863..vl6Y (Notes)" format.
2025-11-17 10:39:22 - Fixed PR review issue in TokenSanitizingFilter: Added record.args = () to clear args when replacing record.msg with already-formatted sanitized message, preventing TypeError from double-formatting when handlers try to apply args to formatted message.
2025-11-17 13:36:XX - Reduced log verbosity: Set httpx, httpcore, and telegram loggers to WARNING level to prevent spam from HTTP request logs. Fixed TokenSanitizingFilter formatting error by sanitizing message components before formatting instead of after, preventing "TypeError: not all arguments converted during string formatting" errors.
2025-11-27 XX:XX:XX - Added food_bot.py: New Telegram bot for food logging similar to workout_bot. Added save_food_log method to ApiAdapter that POSTs to /food-logs endpoint. Created food_bot.env configuration file and added food_bot service to docker_compose.yml with docker-services-network connectivity.
2025-12-10 XX:XX:XX - Fixed AttributeError in bot_common.py: Added None checks for ALLOWED_CHAT_IDS and STARTUP_CHAT_IDS_REPORT environment variables. The sleep_bot container was restarting because bot_common.py tried to call .split() on None when these variables were not set. Fixed by providing empty string defaults and filtering empty values. Deployed fix to VPS - sleep bot now running successfully.
2025-12-10 XX:XX:XX - Improved API adapter resilience: Added retry logic with exponential backoff (3 retries) for transient errors (timeouts, 5xx server errors, connection errors). Increased default timeout from 10s to 30s to handle slow data-manager responses during webhook processing. Improved error messages to include exception types. This handles ReadTimeout errors when data-manager is busy processing webhooks.
2025-01-15 XX:XX:XX - Fixed PR review issue in deploy-vps.sh: Replaced hardcoded 'docker compose' in log messages with $COMPOSE_CMD variable to respect docker-compose v1 fallback. Final log instructions now work correctly on servers with only docker-compose v1 installed.
2025-01-15 XX:XX:XX - Deployed to VPS: All 6 containers (whisper-bot, notes-bot, dev-bot, sleep-bot, workout-bot, food-bot) built and started successfully. All containers verified running with no startup errors in logs.
2025-01-XX XX:XX:XX - Assessed impact of Docker base image upgrade: Created comprehensive assessment document (DOCKER_BASE_IMAGE_UPGRADE_ASSESSMENT.md) analyzing upgrade from python:3.10-slim to python:3.11-slim-bookworm. Found low risk (no code changes), high benefit (fixes 55 vulnerabilities), low effort (single line change). Identified 6 production bots, ARM Dockerfile needs separate handling, recommended phased deployment approach with testing plan.
2025-01-XX XX:XX:XX - Upgraded Docker base images to python:3.11-slim-bookworm: Updated Dockerfile from python:3.10-slim to python:3.11-slim-bookworm and Dockerfile_arm from arm32v7/python to arm32v7/python:3.11-slim-bookworm. This upgrade addresses 55 security vulnerabilities (9 CRITICAL, 46 HIGH) by moving from Debian 11 (bullseye) to Debian 12 (bookworm) base. Ready for testing and deployment.
2025-12-11 17:43:XX - Deployed Docker base image upgrade to VPS: Successfully deployed all 6 bots (whisper-bot, notes-bot, dev-bot, sleep-bot, workout-bot, food-bot) with python:3.11-slim-bookworm base image. All containers built and started successfully with Python 3.11.14. No errors in logs, all bots running and connecting to Telegram API. Security upgrade complete - addresses 55 vulnerabilities from previous Debian 11 base.
2025-01-15 XX:XX:XX - Added ping/pong functionality to workout_bot: Implemented /ping command handler and ping message detection in action_save_note. Bot now responds with "pong" to both "/ping" commands and "ping" messages without storing anything in the database.
